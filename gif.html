<html><head>
    <script src="bits.js"></script>
    <script src="bytestream.js"></script>
    <script src="lzw2.js"></script>
    <script src="lzw.js"></script>
    <script src="gif.js"></script>
    <script>
      var toBytes = function(string) {
        var result = [];
        for(var i = 0; i < string.length; i++) {
          result.push(String.fromCharCode(string.charCodeAt(i) & 0xFF));
        }
        return result.join("");
      };
      var getFile = function(fname, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if(xhr.readyState === 4 && xhr.status === 200) {
            callback(xhr.responseText);
          }
        };
        xhr.open("GET", fname);
        xhr.overrideMimeType('text/plain; charset=x-user-defined'); 
        xhr.send();
      };
        var charCodes = function(s) {
        var result = [];
        for(var i = 0; i <s.length; i++)
          result.push(s.charCodeAt(i).toString(16));
          //result.push((s.charCodeAt(i) & 0xFF).toString(16));
        return result
      }
      var blobUrl = function(data) {
        var bb = new WebKitBlobBuilder();
        bb.append(data);
        return webkitURL.createObjectURL(bb.getBlob());
      };

      var stringIntoBytes = function(str) {
        var buf = new ArrayBuffer(str.length);
        var arr = new Uint8Array(buf);
        for(var i = 0; i < arr.length; i++)
          arr[i] = str.charCodeAt(i);
        return buf;
      };

      test = function() {
        g = getFile("gifs/lasercat.gif", function(gifdata) {
          bindata = gifdata;
          g = new Gif();
          now = Date.now();
          g.decode(new ByteStream(gifdata));
          duration = Date.now() - now;
          console.log(duration / 1000);
          doStuff(g);
        });
      };
      var doStuff = function(gif) {
        var redraw = prep(gif);
        window.setInterval(function() { redraw(1); }, 100);
      };
      var prep = function(gif) {
        var rows = 2;
        var cols = 4;
        var width = gif.screen.width;
        var height = gif.screen.height;
        var cWidth = width * cols;
        var cHeight = height * rows;
        var canvas = document.createElement("canvas");
        canvas.setAttribute("width", cWidth);
        canvas.setAttribute("height", cWidth);
        document.body.appendChild(canvas);
        var ctx = canvas.getContext("2d");
        var images = gif.blocks.filter(function(x) { return x instanceof Image; });
        var pv = gif.screen.globalPalette.values;
        var blockIx = 0;
        return function(delta) {
          var iix = blockIx % images.length;
          for(var row = 0; row < rows; row++) {
            for(var col = 0; col < cols; col++) {
              var img = images[iix];
              //iix = (images.length + iix + (rows - 1) * Math.floor(images.length / rows / cols)) % images.length;
              //iix = (iix + 1) % images.length;
              iix = (images.length + iix + Math.floor(images.length / rows / cols)) % images.length;
              var rr = img.rect;
              var pixels = ctx.createImageData(rr.width, rr.height);
              var pary = pixels.data;
              for(var ix = 0; ix < height * width; ix++) {
                var v = img.pixels[ix];
                pary[4*ix] = pv[3*v];
                pary[4*ix + 1] = pv[3*v + 1];
                pary[4*ix + 2] = pv[3*v + 2];
                pary[4*ix + 3] = 255;
              }
              var left = width * col + rr.left;
              var top = height * row + rr.top; 
              ctx.clearRect(left, top, rr.width, rr.height);
              ctx.putImageData(pixels, left, top); 
            }
          }
          blockIx += delta;
          blockIx = blockIx % images.length;
        };
      }


    </script>
  </head>
</html>
