<html><head>
    <script src="bits.js"></script>
    <script src="bytestream.js"></script>
    <script src="lzw2.js"></script>
    <script src="lzw.js"></script>
    <script src="gif.js"></script>
    <script>
      var toBytes = function(string) {
        var result = [];
        for(var i = 0; i < string.length; i++) {
          result.push(String.fromCharCode(string.charCodeAt(i) & 0xFF));
        }
        return result.join("");
      };
      var getFile = function(fname, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if(xhr.readyState === 4 && xhr.status === 200) {
            callback(xhr.responseText);
          }
        };
        xhr.open("GET", fname);
        xhr.overrideMimeType('text/plain; charset=x-user-defined'); 
        xhr.send();
      };
        var charCodes = function(s) {
        var result = [];
        for(var i = 0; i <s.length; i++)
          result.push(s.charCodeAt(i).toString(16));
          //result.push((s.charCodeAt(i) & 0xFF).toString(16));
        return result
      }
      roundtrips = function(g) {
        var blocks = [];
        blocks.push(g.screen);
        for(var i = 0; i < Math.min(5, g.blocks.length); i++) {
          blocks.push(g.blocks[i]);
        }
        for(var i = 0; i < blocks.length; i++) {
          var block = blocks[i];
          var constructor = block.__proto__.constructor;
          var encoded = block.encode();
          var decoded = new constructor();
          if(!decoded.decode(new ByteStream(encoded))) {
            throw constructor.toString();
          }
          var roundtrip = decoded.encode();
          console.log(block);
          console.log(roundtrip == encoded);
          console.log("==================");

        }
        
      };
      var diffbins = function(a, b) {
        if(a.length != b.length)
          throw "diff lengths";
        var diffs = [];
        for(var i = 0; i < a.length; i++) {
          var ac = a.charCodeAt(i) & 0xFF;
          var bc = b.charCodeAt(i) & 0xFF;
          if(ac != bc) {
            diffs.push([i, ac, bc]);
          }
        }
        return diffs;
      };
      var blobUrl = function(data) {
        var bb = new WebKitBlobBuilder();
        bb.append(data);
        return webkitURL.createObjectURL(bb.getBlob());
      };
      var stringIntoBytes = function(str) {
        var buf = new ArrayBuffer(str.length);
        var arr = new Uint8Array(buf);
        for(var i = 0; i < arr.length; i++)
          arr[i] = str.charCodeAt(i);
        return buf;
      };
      test = function() {
        g = getFile("gifs/bwanim.gif", function(gifdata) {
          bindata = gifdata;
          g = new Gif();
          now = Date.now();
          g.decode(new ByteStream(gifdata));
          duration = Date.now() - now;
          console.log(g);
          console.log(duration / 1000);
          roundtrips(g);
        });

      };

    </script>
  </head>
</html>
